<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <var name="administrator" class="org.encuestame.core.config.AdministratorProfile" />

    <view-state id="setup">
        <on-entry>
            <evaluate  expression="setupService.checkStatus()" result="flowScope.status"></evaluate>
        </on-entry>
        <transition on="upgrade-submit" to="upgrade-setup" />
        <transition on="install-submit" to="install-setup" />
    </view-state>

    <view-state id="upgrade-setup">
        <transition on="next" to="dashboard" history="discard" />
    </view-state>

    <view-state id="install-setup">
        <on-entry>
            <evaluate expression="setupService.loadInstallParameters()" result="flowScope.sqlparam"></evaluate>
        </on-entry>
        <transition on="create">
            <evaluate expression="setupService.installDatabase()"
                result="flowScope.state" result-type="java.lang.String"></evaluate>
            <evaluate expression="setupService.getScriptLog()" result="flowScope.sql"></evaluate>
        </transition>
        <transition on="reinstall">
            <evaluate expression="setupService.removeTables()" result="flowScope.removed"></evaluate>
        </transition>
        <transition on="yes" to="installAdmon">
            <evaluate expression="setupService.demoInstall()"></evaluate>
        </transition>
        <transition on="no" to="installAdmon"/>
    </view-state>

    <view-state id="installAdmon" model="administrator">
        <binder>
            <binding property="username" />
            <binding property="password" />
            <binding property="confirmPassword" />
            <binding property="email" />
            <binding property="confirmEmail" />
        </binder>
        <transition on="create-user" to="review-admon" validate="true">
            <evaluate expression="setupService.createUserAdministration(administrator)" result="flowScope.admon">
            </evaluate>
        </transition>
    </view-state>

    <view-state id="editAdmon">
        <transition on="save-user" to="review-admon"/>
        <transition on="cancel-user" to="review-admon"/>
    </view-state>

    <view-state id="review-admon">
        <transition on="valid-user" to="install-check"/>
        <transition on="edit-user" to="editAdmon"/>
    </view-state>

    <view-state id="install-check">
        <transition on="finish" to="home"></transition>
        <transition on-exception="java.lang.Exception" to="displayError"></transition>
    </view-state>

    <view-state id="displayError"></view-state>

    <end-state id="home" view="externalRedirect:contextRelative:/home">
    </end-state>

</flow>
